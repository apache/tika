//
// Licensed to the Apache Software Foundation (ASF) under one or more
// contributor license agreements.  See the NOTICE file distributed with
// this work for additional information regarding copyright ownership.
// The ASF licenses this file to You under the Apache License, Version 2.0
// (the "License"); you may not use this file except in compliance with
// the License.  You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

= Embedded Document Metadata

When Tika parses container files (such as ZIP archives, emails, PDFs with attachments, or
Microsoft Office documents), it extracts embedded documents recursively. Tika provides
several metadata fields to help you understand and track the structure of these embedded
resources.

== Overview

Embedded document metadata falls into two categories:

* *Tika-Generated Metadata* - Fields that Tika calculates during parsing to help you
  understand the document structure
* *Internal File Metadata* - Fields that come directly from the container file's own
  metadata storage

== Tika-Generated Metadata

These fields are generated by Tika during parsing and reflect the structure of embedded
resources as Tika encounters them. All fields below are defined in `TikaCoreProperties`.

=== Structure Tracking

`TikaCoreProperties.EMBEDDED_ID` (`X-TIKA:embedded_id`)::
A 1-indexed integer assigned by Tika to each embedded document during parsing. These IDs
are assigned in the order documents are encountered by the `RecursiveParserWrapper`.

`TikaCoreProperties.EMBEDDED_ID_PATH` (`X-TIKA:embedded_id_path`)::
A path-like representation of the embedded document's position in the hierarchy, built
from `EMBEDDED_ID` values. For example, `/1/3` indicates that the file with `EMBEDDED_ID=3`
was an attachment within the file with `EMBEDDED_ID=1`. This is the most robust path for
tracking document structure.

=== Path Synthesis

`TikaCoreProperties.EMBEDDED_RESOURCE_PATH` (`X-TIKA:embedded_resource_path`)::
A synthetic path generated by concatenating file names (from `RESOURCE_NAME_KEY`) for each
level of embedding. This provides a human-readable path through the document hierarchy.
+
WARNING: Do not use this field for creating directory structures to write out attachments.
There may be path collisions, illegal characters, or zip slip vulnerabilities. Use `EMBEDDED_ID_PATH`
for reliable path tracking.

`TikaCoreProperties.FINAL_EMBEDDED_RESOURCE_PATH` (`X-TIKA:final_embedded_resource_path`)::
Similar to `EMBEDDED_RESOURCE_PATH`, but calculated at the end of the full parse rather
than during parsing. For some parsers, an embedded file's name isn't known until after its
child files have been parsed. This field may have fewer "unknown" file names than
`EMBEDDED_RESOURCE_PATH`, but the synthetic names (e.g., `embedded-1`) are not correlated
between the two fields.

=== Resource Naming

`TikaCoreProperties.RESOURCE_NAME_KEY` (`X-TIKA:resourceName`)::
The "name" of the resource. Tika makes a best effort to determine a meaningful name for
each embedded resource. When a name cannot be determined from the container file's
metadata, Tika falls back to synthetic names such as `embedded-1.jpeg`.
+
NOTE: In Tika 3.x, this field may or may not include path information depending on the
parser. In 4.x, use `INTERNAL_PATH` for the full path as stored in the container.

== Internal File Metadata

These fields contain metadata that is stored within the container file itself, not
generated by Tika. All fields below are defined in `TikaCoreProperties`.

=== Path and Location

`TikaCoreProperties.INTERNAL_PATH` (`X-TIKA:internalPath`)::
The path including file name as literally stored within the container file (e.g., in a
TAR, ZIP, or PST file). This is distinct from `EMBEDDED_RESOURCE_PATH` in two ways:
+
1. It is the actual metadata from the container, not synthetically generated
2. It may include folder/directory information that the container preserves

`TikaCoreProperties.ORIGINAL_RESOURCE_NAME` (`X-TIKA:origResourceName`)::
For some file formats, this contains the original path where the file was stored on the
creator's system before being embedded. For example, older `.doc` files and `.xlsx` files
may store the original file system path from the author's computer.

== Microsoft-Specific Metadata

Microsoft Office formats use additional identifiers for embedded objects.

`TikaCoreProperties.EMBEDDED_RELATIONSHIP_ID` (`X-TIKA:embeddedRelationshipId`)::
A Microsoft-specific identifier used internally to reference embedded objects within
Office documents. This is the relationship ID from the Office Open XML or OLE structure.

`Office.EMBEDDED_STORAGE_CLASS_ID` (`msoffice:embeddedStorageClassId`)::
A UUID that identifies the class of embedded object in Microsoft formats. While not
exactly a MIME type, it provides similar information about what type of object is
embedded. Defined in the `Office` metadata class.

== Quick Reference

[cols="2,2,1"]
|===
|Property |Metadata Key |Source

|`EMBEDDED_ID`
|`X-TIKA:embedded_id`
|Tika-generated

|`EMBEDDED_ID_PATH`
|`X-TIKA:embedded_id_path`
|Tika-generated

|`EMBEDDED_RESOURCE_PATH`
|`X-TIKA:embedded_resource_path`
|Tika-generated

|`FINAL_EMBEDDED_RESOURCE_PATH`
|`X-TIKA:final_embedded_resource_path`
|Tika-generated

|`RESOURCE_NAME_KEY`
|`X-TIKA:resourceName`
|Tika-generated

|`INTERNAL_PATH`
|`X-TIKA:internalPath`
|From container

|`ORIGINAL_RESOURCE_NAME`
|`X-TIKA:origResourceName`
|From container

|`EMBEDDED_RELATIONSHIP_ID`
|`X-TIKA:embeddedRelationshipId`
|From container (MS)

|`Office.EMBEDDED_STORAGE_CLASS_ID`
|`msoffice:embeddedStorageClassId`
|From container (MS)
|===

== Example: Understanding the Difference

Consider a ZIP file `archive.zip` containing `reports/Q1/sales.xlsx`, where the spreadsheet
itself contains an embedded image:

[cols="1,2,2"]
|===
|Document |Field |Value

.5+|Container (`archive.zip`)
|`EMBEDDED_ID`
|_(not set - this is the root document)_

|`EMBEDDED_ID_PATH`
|_(not set)_

|`INTERNAL_PATH`
|_(not set)_

|`RESOURCE_NAME_KEY`
|`archive.zip`

|`EMBEDDED_RESOURCE_PATH`
|_(not set)_

.5+|Spreadsheet (`sales.xlsx`)
|`EMBEDDED_ID`
|`1`

|`EMBEDDED_ID_PATH`
|`/1`

|`INTERNAL_PATH`
|`reports/Q1/sales.xlsx` (from ZIP entry)

|`RESOURCE_NAME_KEY`
|`sales.xlsx`

|`EMBEDDED_RESOURCE_PATH`
|`/sales.xlsx`

.5+|Embedded image in spreadsheet
|`EMBEDDED_ID`
|`2`

|`EMBEDDED_ID_PATH`
|`/1/2` (embedded in file with ID=1)

|`INTERNAL_PATH`
|`xl/media/image1.png` (from XLSX structure)

|`RESOURCE_NAME_KEY`
|`image1.png`

|`EMBEDDED_RESOURCE_PATH`
|`/sales.xlsx/image1.png`
|===

Key observations:

* `INTERNAL_PATH` preserves the full directory structure as it was stored from each container
* `EMBEDDED_RESOURCE_PATH` is built only from file names at each level
* `EMBEDDED_ID_PATH` `/1/2` shows that the image (ID=2) was found inside the spreadsheet (ID=1)
