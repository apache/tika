//
// Licensed to the Apache Software Foundation (ASF) under one or more
// contributor license agreements.  See the NOTICE file distributed with
// this work for additional information regarding copyright ownership.
// The ASF licenses this file to You under the Apache License, Version 2.0
// (the "License"); you may not use this file except in compliance with
// the License.  You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//

= Migrating to Tika 4.x

This guide covers the changes required when upgrading from Apache Tika 3.x to 4.x.

See the xref:roadmap.adoc[Roadmap] for version timelines and support schedules.

== Requirements

* Java 17 or later (upgraded from Java 11 in 3.x)

== Configuration: XML to JSON

Tika 4.x uses JSON configuration files instead of XML. The legacy `tika-config.xml` format
is no longer supported.

=== Automatic Conversion

Tika provides a conversion tool in `tika-app` to help migrate your XML configuration:

[source,bash]
----
java -jar tika-app.jar --convert-config-xml-to-json=tika-config.xml,tika-config.json
----

The converter currently supports:

* **Parsers section** - parser declarations with parameters and exclusions
* **Parameter types** - bool, int, long, double, float, string, list, and map
* **Special handling** - TesseractOCR's `otherTesseractSettings` list is automatically
  converted to the `otherTesseractConfig` map format

=== Example Conversion

**XML Format (3.x):**
[source,xml]
----
<properties>
  <parsers>
    <parser class="org.apache.tika.parser.pdf.PDFParser">
      <params>
        <param name="sortByPosition" type="bool">true</param>
        <param name="maxMainMemoryBytes" type="long">1000000</param>
      </params>
    </parser>
    <parser class="org.apache.tika.parser.DefaultParser">
      <parser-exclude class="org.apache.tika.parser.pdf.PDFParser"/>
    </parser>
  </parsers>
</properties>
----

**JSON Format (4.x):**
[source,json]
----
{
  "parsers": [
    {
      "pdf-parser": {
        "sortByPosition": true,
        "maxMainMemoryBytes": 1000000
      }
    },
    {
      "default-parser": {
        "_exclude": ["pdf-parser"]
      }
    }
  ]
}
----

=== Key Differences

[cols="1,1,2"]
|===
|Aspect |XML (3.x) |JSON (4.x)

|Class references
|Full class name (`org.apache.tika.parser.pdf.PDFParser`)
|Kebab-case component name (`pdf-parser`)

|Parameters
|`<param name="..." type="...">value</param>`
|Direct key-value pairs

|Exclusions
|`<parser-exclude class="..."/>`
|`"_exclude": ["component-name"]`
|===

NOTE: When you configure a parser with specific settings in JSON, the loader automatically
excludes it from SPI loading. Explicit exclusions are only needed when you want to disable
a parser entirely without providing custom configuration.

=== Limitations

The automatic converter has some limitations:

* Only the `parsers` section is currently converted
* Detectors and other sections require manual migration
* Custom or third-party parsers not in the registry will use kebab-case name conversion

=== Parser Configuration Changes

WARNING: The configuration options for `PDFParser` and `TesseractOCRParser` have changed
significantly in 4.x. The automatic converter will migrate your parameter names, but you
should review the updated documentation to ensure your configuration is optimal.

See:

* xref:configuration/parsers/pdf-parser.adoc[PDFParser Configuration] - Updated options for PDF parsing
* xref:configuration/parsers/tesseract-ocr-parser.adoc[TesseractOCRParser Configuration] - Updated OCR options

=== Full Configuration Example

Below is a complete example of a Tika 4.x JSON configuration file with commonly configured parsers:

[source,json]
----
include::example$migration-full-example.json[]
----

NOTE: This example shows common options. See the individual parser configuration pages for
complete documentation of all available options.

== Metadata Key Changes

Tika 4.x prefixes all "user generated" metadata keys to prevent overwrites and improve
namespace clarity.

See xref:migration-to-4x/metadata-changes-4x.adoc[Metadata Changes in 4.x] for complete details, including
a full table of changes and code migration examples.

== API Changes

// TODO: Document API changes

== Deprecations and Removals

// TODO: Document deprecated and removed features
