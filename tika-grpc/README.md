# Tika Pipes GRPC Server

The following is the Tika Pipes GRPC Server.

This server will manage a pool of Tika Pipes clients.

* Tika Pipes Fetcher CRUD operations
    * Create
    * Read
    * Update
    * Delete
* Fetch + Parse a given Fetch Item

## Plugin Development Mode

When developing plugins, you can use pf4j's development mode to load plugins directly from their `target/classes` directories without needing to package them as ZIP files. This significantly speeds up the development cycle.

### Enabling Development Mode

Set one of the following:

**System Property:**
```bash
-Dtika.plugin.dev.mode=true
```

**Environment Variable:**
```bash
export TIKA_PLUGIN_DEV_MODE=true
```

### Configuration Example

In your Tika configuration JSON, point `plugin-roots` to the unpackaged plugin directories:

```json
{
  "plugin-roots": [
    "/path/to/tika/tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes",
    "/path/to/tika/tika-pipes/tika-pipes-plugins/tika-pipes-file-system/target/classes",
    "/path/to/tika/tika-pipes/tika-pipes-plugins/tika-pipes-kafka/target/classes"
  ],
  "fetchers": [
    {
      "s3": {
        "myS3Fetcher": {
          "region": "us-east-1",
          "bucket": "my-bucket"
        }
      }
    }
  ]
}
```

### Development Workflow

1. **Build the plugin modules** (only needed once or when dependencies change):
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean compile
   ```

2. **Enable development mode** via system property or environment variable:
   ```bash
   export TIKA_PLUGIN_DEV_MODE=true
   ```

3. **Configure plugin-roots** to point to `target/classes` directories in your config JSON

4. **Run your application** - plugins will be loaded directly from the class directories:
   ```bash
   java -jar tika-grpc-server.jar --config my-config.json
   ```

5. **Make code changes** to your plugin

6. **Recompile just the changed plugin** (much faster than full rebuild):
   ```bash
   cd tika-pipes/tika-pipes-plugins/tika-pipes-s3
   mvn compile
   ```

7. **Restart your application** - changes are immediately picked up

### What Happens in Development Mode

- **ZIP extraction is skipped** - TikaPluginManager doesn't try to unzip plugins
- **Plugins loaded from directories** - pf4j loads classes directly from `target/classes`
- **Each plugin directory must contain** `plugin.properties` in the root (already present after `mvn compile`)

### Example Directory Structure

When pointing to `target/classes`, pf4j expects this structure:

```
tika-pipes-s3/target/classes/
├── plugin.properties          # Required: plugin metadata
├── META-INF/
│   └── extensions.idx         # Generated by pf4j annotation processor
└── org/
    └── apache/
        └── tika/
            └── pipes/
                └── fetcher/
                    └── s3/
                        ├── S3Fetcher.class
                        └── S3FetcherFactory.class
```

### Multiple Plugins During Development

You can load multiple plugins simultaneously by listing all their `target/classes` directories:

```json
{
  "plugin-roots": [
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes",
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-kafka/target/classes",
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-opensearch/target/classes"
  ]
}
```

### Switching Back to Production Mode

For production deployments, use packaged ZIP files:

1. **Remove or set development mode to false**:
   ```bash
   unset TIKA_PLUGIN_DEV_MODE
   # OR
   export TIKA_PLUGIN_DEV_MODE=false
   ```

2. **Build plugin ZIPs**:
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean package
   ```

3. **Update plugin-roots** to point to the directory containing ZIP files:
   ```json
   {
     "plugin-roots": [
       "/opt/tika/plugins"
     ]
   }
   ```

4. **Place plugin ZIPs** in the configured directory:
   ```bash
   cp tika-pipes-plugins/*/target/*.zip /opt/tika/plugins/
   ```

### Troubleshooting

**Plugin not loading?**
- Ensure `mvn compile` was run on the plugin module
- Check that `plugin.properties` exists in `target/classes/`
- Verify development mode is enabled
- Look for "DEVELOPMENT mode" in the logs on startup

**Changes not picked up?**
- Recompile the plugin module: `mvn compile`
- Restart the application
- Check that you're editing the correct plugin module

### References

- [pf4j Development Mode Documentation](https://pf4j.org/doc/development-mode.html)
- [JIRA TIKA-4587](https://issues.apache.org/jira/browse/TIKA-4587) - Development mode implementation

