# Tika Pipes GRPC Server

The following is the Tika Pipes GRPC Server.

This server will manage a pool of Tika Pipes clients.

* Tika Pipes Fetcher CRUD operations
    * Create
    * Read
    * Update
    * Delete
* Fetch + Parse a given Fetch Item

## Quick Start - Development Mode

The fastest way to run tika-grpc in development mode with plugin hot-reloading:

```bash
# 1. Build Tika and all plugins (from tika project root)
mvn clean install -DskipTests

# 2. Run in development mode (from tika-grpc directory)
cd tika-grpc
./run-dev.sh
```

This will:
- Automatically enable `tika.plugin.dev.mode=true`
- Load plugins from `../tika-pipes/tika-pipes-plugins/*/target/classes` directories
- Start gRPC server on port 50052
- Use the `dev-tika-config.json` configuration

You can also specify a custom config file:
```bash
./run-dev.sh my-custom-config.json
```

## Plugin Development Mode

When developing plugins, you can use pf4j's development mode to load plugins directly from their `target/classes` directories without needing to package them as ZIP files. This significantly speeds up the development cycle.

### Enabling Development Mode

Set one of the following:

**System Property:**
```bash
-Dtika.plugin.dev.mode=true
```

**Environment Variable:**
```bash
export TIKA_PLUGIN_DEV_MODE=true
```

**Maven Dev Profile:** (Recommended)
```bash
mvn exec:java -Pdev -Dconfig.file=dev-tika-config.json
```

### Configuration Example

The `dev-tika-config.json` file shows how to configure plugin-roots with relative paths:

```json
{
  "plugin-roots": [
    "../tika-pipes/tika-pipes-plugins/tika-pipes-file-system/target/classes",
    "../tika-pipes/tika-pipes-plugins/tika-pipes-http/target/classes",
    "../tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes"
  ],
  "fetchers": [
    {
      "fs": {
        "myFetcher": {
          "basePath": "/tmp/input"
        }
      }
    }
  ]
}
```

**Note:** Paths are relative to the `tika-grpc` directory (where you run the server from). You can also use absolute paths if preferred:

```json
{
  "plugin-roots": [
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes",
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-file-system/target/classes"
  ]
}
```

### Development Workflow

1. **Build the plugin modules** (only needed once or when dependencies change):
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean compile
   ```

2. **Run in development mode** using the convenience script:
   ```bash
   cd tika-grpc
   ./run-dev.sh
   ```

3. **Make code changes** to your plugin

4. **Recompile just the changed plugin** (much faster than full rebuild):
   ```bash
   cd tika-pipes/tika-pipes-plugins/tika-pipes-s3
   mvn compile
   ```

5. **Restart the server** - changes are immediately picked up

### What Happens in Development Mode

- **ZIP extraction is skipped** - TikaPluginManager doesn't try to unzip plugins
- **Plugins loaded from directories** - pf4j loads classes directly from `target/classes`
- **Each plugin directory must contain** `plugin.properties` in the root (automatically present after `mvn compile`)
- **Dependencies are available** - The dev profile includes all plugin modules as dependencies

### Expected Directory Structure

When pointing to `target/classes`, pf4j expects this structure:

```
tika-pipes-s3/target/classes/
├── plugin.properties          # Required: plugin metadata
├── META-INF/
│   └── extensions.idx         # Generated by pf4j annotation processor
└── org/
    └── apache/
        └── tika/
            └── pipes/
                └── fetcher/
                    └── s3/
                        ├── S3Fetcher.class
                        └── S3FetcherFactory.class
```

### IntelliJ IDEA Setup

For IntelliJ IDEA development, here's a complete workflow for developing plugins:

#### Initial Setup

1. **Import the Tika project** as a Maven project in IntelliJ

2. **Build all plugins once** (required before first run):
   - Open the Maven tool window: View → Tool Windows → Maven
   - Navigate to: **tika-pipes-plugins** (the parent module)
   - Right-click → Lifecycle → **compile**
   - Or use terminal:
     ```bash
     cd tika-pipes/tika-pipes-plugins
     mvn clean compile
     ```

3. **Create a Run Configuration** for tika-grpc:
   - Go to: Run → Edit Configurations
   - Click `+` → Application
   - **Name:** Tika gRPC Server (Dev Mode)
   - **Main class:** `org.apache.tika.pipes.grpc.TikaGrpcServer`
   - **VM options:** `-Dtika.plugin.dev.mode=true`
   - **Program arguments:** `--config dev-tika-config.json`
   - **Working directory:** `$PROJECT_DIR$/tika-grpc`
   - **Use classpath of module:** `tika-grpc`
   - Click OK

4. **Run the configuration** - You should see output like:
   ```
   INFO  TikaPluginManager running in DEVELOPMENT mode
   INFO  PF4J version 3.14.0 in 'development' mode
   INFO  Plugin 'tika-pipes-file-system-plugin@4.0.0-SNAPSHOT' resolved
   INFO  Plugin 'tika-pipes-s3-plugin@4.0.0-SNAPSHOT' resolved
   ...
   INFO  Server started, listening on 50052
   ```

#### Development Workflow: Making Plugin Changes

**Scenario:** You want to modify the S3 Fetcher plugin

1. **Navigate to the plugin code:**
   ```
   tika-pipes/tika-pipes-plugins/tika-pipes-s3/src/main/java/
   ```

2. **Make your code changes** in the plugin source files
   - Edit fetcher, emitter, or iterator classes
   - Modify configuration handling
   - Add new features

3. **Build just the modified plugin module:**
   - In Project view, right-click on **tika-pipes-s3** module
   - Select **Build Module 'tika-pipes-s3.main'**
   - Or use terminal:
     ```bash
     cd tika-pipes/tika-pipes-plugins/tika-pipes-s3
     mvn compile
     ```
   - Build time: ~5-10 seconds (much faster than full rebuild!)

4. **Restart the tika-grpc server:**
   - **You MUST restart** for changes to take effect
   - Click the stop button (red square) in IntelliJ
   - Click run button (green arrow) to restart
   - PF4J loads plugins at startup - no hot reload without restart

5. **Verify your changes:**
   - Check the server logs for successful plugin loading
   - Test your changes via gRPC client
   - Make additional changes and repeat steps 3-4 as needed

#### Tips for Faster Development

**Use IntelliJ's Build shortcuts:**
- `Ctrl+F9` (Windows/Linux) or `Cmd+F9` (Mac) - Build project/module
- Configure to build only changed files for even faster iteration

**Debug mode:**
- Use "Debug" instead of "Run" to set breakpoints in plugin code
- Step through plugin initialization and execution
- Inspect variables and plugin state

**Multiple terminal windows:**
- Terminal 1: Run `./run-dev.sh` 
- Terminal 2: Quick builds with `mvn compile` in plugin directory
- Restart server with Ctrl+C and up-arrow to re-run

**Keyboard shortcut for restart:**
- Set up: Preferences → Keymap → Search for "Rerun"
- Assign a hotkey to "Rerun 'Tika gRPC Server (Dev Mode)'"
- Quick restart: One keystroke instead of mouse clicking

#### Common Issues and Solutions

**"ClassNotFoundException" after changes:**
- Make sure you ran **Build Module** on the changed plugin
- Check that `target/classes` was updated (look at file timestamps)
- Do a clean compile: `mvn clean compile`

**Changes not visible after restart:**
- Verify you built the correct module (check module name in IntelliJ)
- Ensure the config file points to the right `target/classes` directory
- Check that development mode is enabled (look for "DEVELOPMENT mode" in logs)

**Server won't start:**
- Build ALL plugins first: `cd tika-pipes/tika-pipes-plugins && mvn compile`
- Check that `dev-tika-config.json` exists in the working directory
- Verify working directory is set to `$PROJECT_DIR$/tika-grpc`

**Want to see what changed:**
- Before restarting, add a log statement to verify your change
- Check the plugin's version in startup logs
- Use debugger to set breakpoint in modified code

#### Alternative: Maven Exec from IntelliJ

Instead of creating an Application run configuration, you can also run the Maven goal directly:

1. **Open Maven tool window**
2. **Navigate to:** tika-grpc → Profiles → dev (check the checkbox)
3. **Navigate to:** tika-grpc → Plugins → exec → exec:java
4. **Right-click exec:java** → Run
5. **To use custom config:** Edit the run configuration and add:
   ```
   -Dconfig.file=my-config.json
   ```

Same workflow applies: make changes → build module → restart Maven goal

### Why You Must Restart

**PF4J plugin loading happens at server startup:**
- `TikaPluginManager.loadPlugins()` discovers and loads plugins from directories
- Creates `PluginClassLoader` instances for each plugin
- Instantiates plugin classes and calls `start()` methods
- This happens **once** when the server starts

**No hot reload support (yet):**
- PF4J doesn't automatically detect changed class files
- ClassLoaders are not refreshed during runtime
- Server must be restarted to reload plugin code

**Fast iteration cycle:**
- Compile plugin: ~5-10 seconds
- Restart server: ~10-15 seconds  
- Total: ~20-25 seconds per change
- Much faster than packaging ZIPs (2-3 minutes) or full rebuild (5+ minutes)

### Switching Back to Production Mode

For production deployments, use packaged ZIP files:

1. **Remove or set development mode to false:**
   ```bash
   unset TIKA_PLUGIN_DEV_MODE
   # OR
   export TIKA_PLUGIN_DEV_MODE=false
   ```

2. **Build plugin ZIPs:**
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean package
   ```

3. **Update plugin-roots** to point to the directory containing ZIP files:
   ```json
   {
     "plugin-roots": [
       "/opt/tika/plugins"
     ]
   }
   ```

4. **Place plugin ZIPs** in the configured directory:
   ```bash
   cp tika-pipes-plugins/*/target/*.zip /opt/tika/plugins/
   ```

### Troubleshooting

**Plugin not loading?**
- Ensure `mvn compile` was run on the plugin module
- Check that `plugin.properties` exists in `target/classes/`
- Verify development mode is enabled
- Look for "DEVELOPMENT mode" in the logs on startup

**Changes not picked up?**
- Recompile the plugin module: `mvn compile`
- Restart the application
- Check that you're editing the correct plugin module

**ClassNotFoundException errors?**
- Make sure you built all plugins first with `mvn clean install -DskipTests`
- The dev profile includes all plugin dependencies, but they must be compiled first

### References

- [pf4j Development Mode Documentation](https://pf4j.org/doc/development-mode.html)
- [JIRA TIKA-4587](https://issues.apache.org/jira/browse/TIKA-4587) - Development mode implementation
