# Tika Pipes GRPC Server

The following is the Tika Pipes GRPC Server.

This server will manage a pool of Tika Pipes clients.

* Tika Pipes Fetcher CRUD operations
    * Create
    * Read
    * Update
    * Delete
* Fetch + Parse a given Fetch Item

## Quick Start - Development Mode

The fastest way to run tika-grpc in development mode with plugin hot-reloading:

```bash
# 1. Build Tika and all plugins (from tika project root)
mvn clean install -DskipTests

# 2. Run in development mode (from tika-grpc directory)
cd tika-grpc
./run-dev.sh
```

This will:
- Automatically enable `tika.plugin.dev.mode=true`
- Load plugins from `../tika-pipes/tika-pipes-plugins/*/target/classes` directories
- Start gRPC server on port 50052
- Use the `dev-tika-config.json` configuration

You can also specify a custom config file:
```bash
./run-dev.sh my-custom-config.json
```

## Plugin Development Mode

When developing plugins, you can use pf4j's development mode to load plugins directly from their `target/classes` directories without needing to package them as ZIP files. This significantly speeds up the development cycle.

### Enabling Development Mode

Set one of the following:

**System Property:**
```bash
-Dtika.plugin.dev.mode=true
```

**Environment Variable:**
```bash
export TIKA_PLUGIN_DEV_MODE=true
```

**Maven Dev Profile:** (Recommended)
```bash
mvn exec:java -Pdev -Dconfig.file=dev-tika-config.json
```

### Configuration Example

The `dev-tika-config.json` file shows how to configure plugin-roots with relative paths:

```json
{
  "plugin-roots": [
    "../tika-pipes/tika-pipes-plugins/tika-pipes-file-system/target/classes",
    "../tika-pipes/tika-pipes-plugins/tika-pipes-http/target/classes",
    "../tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes"
  ],
  "fetchers": [
    {
      "fs": {
        "myFetcher": {
          "basePath": "/tmp/input"
        }
      }
    }
  ]
}
```

**Note:** Paths are relative to the `tika-grpc` directory (where you run the server from). You can also use absolute paths if preferred:

```json
{
  "plugin-roots": [
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-s3/target/classes",
    "/home/user/tika/tika-pipes/tika-pipes-plugins/tika-pipes-file-system/target/classes"
  ]
}
```

### Development Workflow

1. **Build the plugin modules** (only needed once or when dependencies change):
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean compile
   ```

2. **Run in development mode** using the convenience script:
   ```bash
   cd tika-grpc
   ./run-dev.sh
   ```

3. **Make code changes** to your plugin

4. **Recompile just the changed plugin** (much faster than full rebuild):
   ```bash
   cd tika-pipes/tika-pipes-plugins/tika-pipes-s3
   mvn compile
   ```

5. **Restart the server** - changes are immediately picked up

### What Happens in Development Mode

- **ZIP extraction is skipped** - TikaPluginManager doesn't try to unzip plugins
- **Plugins loaded from directories** - pf4j loads classes directly from `target/classes`
- **Each plugin directory must contain** `plugin.properties` in the root (automatically present after `mvn compile`)
- **Dependencies are available** - The dev profile includes all plugin modules as dependencies

### Expected Directory Structure

When pointing to `target/classes`, pf4j expects this structure:

```
tika-pipes-s3/target/classes/
├── plugin.properties          # Required: plugin metadata
├── META-INF/
│   └── extensions.idx         # Generated by pf4j annotation processor
└── org/
    └── apache/
        └── tika/
            └── pipes/
                └── fetcher/
                    └── s3/
                        ├── S3Fetcher.class
                        └── S3FetcherFactory.class
```

### IntelliJ IDEA Setup

For IntelliJ IDEA development:

1. **Create a Run Configuration:**
   - Main class: `org.apache.tika.pipes.grpc.TikaGrpcServer`
   - VM options: `-Dtika.plugin.dev.mode=true`
   - Program arguments: `--config dev-tika-config.json`
   - Working directory: `$PROJECT_DIR$/tika-grpc`

2. **Build all plugins once:**
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean compile
   ```

3. **Run** the configuration - plugins will load from `target/classes`

4. **Hot reload:** After making changes, right-click the module → Build Module, then restart

### Switching Back to Production Mode

For production deployments, use packaged ZIP files:

1. **Remove or set development mode to false:**
   ```bash
   unset TIKA_PLUGIN_DEV_MODE
   # OR
   export TIKA_PLUGIN_DEV_MODE=false
   ```

2. **Build plugin ZIPs:**
   ```bash
   cd tika-pipes/tika-pipes-plugins
   mvn clean package
   ```

3. **Update plugin-roots** to point to the directory containing ZIP files:
   ```json
   {
     "plugin-roots": [
       "/opt/tika/plugins"
     ]
   }
   ```

4. **Place plugin ZIPs** in the configured directory:
   ```bash
   cp tika-pipes-plugins/*/target/*.zip /opt/tika/plugins/
   ```

### Troubleshooting

**Plugin not loading?**
- Ensure `mvn compile` was run on the plugin module
- Check that `plugin.properties` exists in `target/classes/`
- Verify development mode is enabled
- Look for "DEVELOPMENT mode" in the logs on startup

**Changes not picked up?**
- Recompile the plugin module: `mvn compile`
- Restart the application
- Check that you're editing the correct plugin module

**ClassNotFoundException errors?**
- Make sure you built all plugins first with `mvn clean install -DskipTests`
- The dev profile includes all plugin dependencies, but they must be compiled first

### References

- [pf4j Development Mode Documentation](https://pf4j.org/doc/development-mode.html)
- [JIRA TIKA-4587](https://issues.apache.org/jira/browse/TIKA-4587) - Development mode implementation
